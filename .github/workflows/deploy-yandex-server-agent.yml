name: ðŸš€ Deploy Yandex Server Agent

on:
  push:
    branches: [ main ]
    paths: 
      - 'server-agent/**'
      - '.github/workflows/deploy-yandex-server-agent.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - restart
        - status
        - logs

jobs:
  deploy:
    name: ðŸ¤– Deploy Agent to VM
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VM_IP_ADDRESS }} >> ~/.ssh/known_hosts
        
    - name: ðŸ“‹ Verify Server Connection
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "echo 'SSH Connection: âœ… Success' && uptime"
          
    - name: ðŸ“¦ Deploy Agent Files
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "sudo mkdir -p ${{ secrets.PROJECT_PATH }}/server-agent"
          
        # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ Ð°Ð³ÐµÐ½Ñ‚Ð°
        scp -i ~/.ssh/id_rsa -r server-agent/* \
          ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }}:${{ secrets.PROJECT_PATH }}/server-agent/
          
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð°
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "sudo chown -R ${{ secrets.VM_USER }}:${{ secrets.VM_USER }} ${{ secrets.PROJECT_PATH }}/server-agent && \
           sudo chmod +x ${{ secrets.PROJECT_PATH }}/server-agent/*.py && \
           sudo chmod +x ${{ secrets.PROJECT_PATH }}/server-agent/*.sh"
           
    - name: âš™ï¸ Update Configuration
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} '
          cd ${{ secrets.PROJECT_PATH }}/server-agent
          
          # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Telegram ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
          sudo sed -i "s/YOUR_BOT_TOKEN_HERE/${{ secrets.TELEGRAM_BOT_TOKEN }}/g" agent-config.json
          sudo sed -i "s/YOUR_ADMIN_CHAT_ID/${{ secrets.TELEGRAM_CHAT_ID }}/g" agent-config.json
          sudo sed -i "s/YOUR_ALERTS_CHAT_ID/${{ secrets.TELEGRAM_CHAT_ID }}/g" agent-config.json
          sudo sed -i "s/YOUR_REPORTS_CHAT_ID/${{ secrets.TELEGRAM_CHAT_ID }}/g" agent-config.json
          
          echo "âœ… Configuration updated"
        '
        
    - name: ðŸ”„ Restart Agent Service
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "sudo systemctl daemon-reload && \
           sudo systemctl restart yandex-server-agent && \
           sudo systemctl enable yandex-server-agent"
           
    - name: âœ… Verify Deployment
      run: |
        sleep 10
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "sudo systemctl status yandex-server-agent --no-pager && \
           echo 'ðŸŽ‰ Deployment successful!'"
           
    - name: ðŸ“± Notify Telegram
      if: always()
      run: |
        STATUS="${{ job.status }}"
        if [ "$STATUS" = "success" ]; then
          MESSAGE="ðŸŽ‰ Yandex Server Agent ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚!%0A%0Aâœ… VM: ${{ secrets.VM_ID }}%0AðŸŒ IP: ${{ secrets.VM_IP_ADDRESS }}%0Aâ° Ð’Ñ€ÐµÐ¼Ñ: $(date)%0AðŸš€ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð£ÑÐ¿ÐµÑˆÐ½Ð¾"
        else
          MESSAGE="âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Yandex Server Agent!%0A%0AðŸ†” VM: ${{ secrets.VM_ID }}%0AðŸŒ IP: ${{ secrets.VM_IP_ADDRESS }}%0Aâ° Ð’Ñ€ÐµÐ¼Ñ: $(date)%0AðŸ’¥ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ÐžÑˆÐ¸Ð±ÐºÐ°"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE"
          
  manual-actions:
    name: ðŸ› ï¸ Manual Actions
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ðŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VM_IP_ADDRESS }} >> ~/.ssh/known_hosts
        
    - name: ðŸŽ¯ Execute Action
      run: |
        case "${{ github.event.inputs.action }}" in
          "restart")
            ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
              "sudo systemctl restart yandex-server-agent"
            echo "ðŸ”„ Agent restarted"
            ;;
          "status")
            ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
              "sudo systemctl status yandex-server-agent --no-pager"
            ;;
          "logs")
            ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
              "sudo journalctl -u yandex-server-agent --no-pager -n 50"
            ;;
        esac
