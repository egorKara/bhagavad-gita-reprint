name: üìä System Monitoring

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: üîë Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VM_IP_ADDRESS }} >> ~/.ssh/known_hosts
        
    - name: üåê Check Server Availability  
      run: |
        if ping -c 3 ${{ secrets.VM_IP_ADDRESS }}; then
          echo "‚úÖ Server is reachable"
        else
          echo "‚ùå Server is unreachable"
          exit 1
        fi
        
    - name: üîç Check Services Status
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} '
          echo "üîç –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ò–°–û–í:"
          echo "===================="
          
          # Yandex Server Agent
          if systemctl is-active yandex-server-agent >/dev/null; then
            echo "‚úÖ Yandex Server Agent: –†–ê–ë–û–¢–ê–ï–¢"
          else
            echo "‚ùå Yandex Server Agent: –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          fi
          
          # Nginx
          if systemctl is-active nginx >/dev/null; then
            echo "‚úÖ Nginx: –†–ê–ë–û–¢–ê–ï–¢"
          else
            echo "‚ùå Nginx: –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          fi
          
          # SSH
          if systemctl is-active ssh >/dev/null; then
            echo "‚úÖ SSH: –†–ê–ë–û–¢–ê–ï–¢"
          else
            echo "‚ùå SSH: –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          fi
          
          echo ""
          echo "üìä –°–ò–°–¢–ï–ú–ù–´–ï –ú–ï–¢–†–ò–ö–ò:"
          echo "===================="
          
          # CPU
          cpu=$(top -bn1 | grep "Cpu(s)" | awk "{print \$2}" | cut -d"%" -f1)
          echo "üñ•Ô∏è CPU: ${cpu}%"
          
          # Memory
          memory=$(free | grep Mem | awk "{printf \"%.1f\", \$3/\$2 * 100.0}")
          echo "üíæ RAM: ${memory}%"
          
          # Disk
          disk=$(df -h / | awk "NR==2{print \$5}")
          echo "üíø Disk: ${disk}"
          
          # Uptime
          echo "‚è∞ Uptime: $(uptime -p)"
        '
        
    - name: ü§ñ Check Agent Logs
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_IP_ADDRESS }} \
          "sudo journalctl -u yandex-server-agent --since '1 hour ago' --no-pager | tail -10"
          
    - name: üì± Send Health Report
      if: always()
      run: |
        STATUS="${{ job.status }}"
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        
        if [ "$STATUS" = "success" ]; then
          MESSAGE="üíö HEALTH CHECK PASSED%0A%0A‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ%0Aüåê IP: ${{ secrets.VM_IP_ADDRESS }}%0A‚è∞ –í—Ä–µ–º—è: $TIMESTAMP%0A%0Aü§ñ Yandex Server Agent –∞–∫—Ç–∏–≤–µ–Ω%0Aüìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç"
        else
          MESSAGE="üö® HEALTH CHECK FAILED%0A%0A‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ —Å–∏—Å—Ç–µ–º–µ%0Aüåê IP: ${{ secrets.VM_IP_ADDRESS }}%0A‚è∞ –í—Ä–µ–º—è: $TIMESTAMP%0A%0A‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE"
