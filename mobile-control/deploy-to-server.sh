#!/bin/bash

# ðŸš€ Ð ÐÐ—Ð’ÐÐ Ð¢Ð«Ð’ÐÐÐ˜Ð• TELEGRAM MASTER BOT ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð•
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Yandex Cloud VM

echo "ðŸš€ Ð ÐÐ—Ð’ÐÐ Ð¢Ð«Ð’ÐÐÐ˜Ð• TELEGRAM MASTER BOT"
echo "==================================="
echo ""

# ðŸŽ¯ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER_IP="46.21.247.218"
SERVER_USER="yc-user"
SSH_KEY="~/.ssh/ssh-key-1753182147967"
BOT_DIR="/home/yc-user/telegram-master-bot"

echo "ðŸ“¡ Ð¡ÐµÑ€Ð²ÐµÑ€: $SERVER_USER@$SERVER_IP"
echo "ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $BOT_DIR"
echo ""

# ðŸ”„ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ SSH
safe_ssh() {
    timeout 15 ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SERVER_USER@$SERVER_IP "$1"
}

# ðŸ“¦ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
echo "ðŸ“¦ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
cd "$(dirname "$0")"

# ðŸš€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
safe_ssh "mkdir -p $BOT_DIR"

# ðŸ“¤ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
echo "ðŸ“¤ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
timeout 30 scp -i $SSH_KEY -o StrictHostKeyChecking=no \
    telegram-master-bot.js \
    package.json \
    README.md \
    config.example.env \
    $SERVER_USER@$SERVER_IP:$BOT_DIR/

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
safe_ssh "cd $BOT_DIR && npm install --production"

# ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
safe_ssh "cd $BOT_DIR && cp config.example.env .env"

# ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
safe_ssh "sudo tee /etc/systemd/system/telegram-master-bot.service > /dev/null << 'EOF'
[Unit]
Description=Telegram Master Bot - Mobile Control Center
After=network.target

[Service]
Type=simple
User=yc-user
WorkingDirectory=$BOT_DIR
ExecStart=/usr/bin/node telegram-master-bot.js
Restart=always
RestartSec=3
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF"

# ðŸ”„ Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸ”„ Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
safe_ssh "sudo systemctl daemon-reload"
safe_ssh "sudo systemctl enable telegram-master-bot"
safe_ssh "sudo systemctl start telegram-master-bot"

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
echo ""
echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ñ€Ð°Ð·Ð²Ñ‘Ñ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ..."
safe_ssh "sudo systemctl status telegram-master-bot --no-pager -l"

echo ""
echo "ðŸŽ‰ Ð ÐÐ—Ð’ÐÐ Ð¢Ð«Ð’ÐÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž!"
echo "=========================="
echo ""
echo "ðŸ“± Telegram Ð±Ð¾Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ:"
echo "   â€¢ ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ @Gita_server_monitor_bot Ð² Telegram"
echo "   â€¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /start Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹"
echo "   â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´"
echo ""
echo "ðŸ”§ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:"
echo "   sudo systemctl status telegram-master-bot"
echo "   sudo systemctl restart telegram-master-bot"
echo "   sudo systemctl logs telegram-master-bot"
echo ""
echo "ðŸš€ ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ†ÐµÐ½Ñ‚Ñ€ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½!"
