#!/usr/bin/env bash
# –°–æ–∑–¥–∞–Ω–∏–µ PR –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è BugBot –°–ï–ô–ß–ê–°

set -euo pipefail

echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ BugBot Test PR –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
echo "=========================================================="

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
if [[ ! "$CURRENT_BRANCH" =~ ^test/bugbot-execution ]]; then
    echo "‚ùå –ù–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ç–∫–µ. –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
    exit 1
fi

PR_TITLE="ü§ñ BugBot Execution Test - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞"

# –û–ø–∏—Å–∞–Ω–∏–µ PR –Ω–∞ —Ä—É—Å—Å–∫–æ–º (—Ç–∞–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ç–µ–ø–µ—Ä—å —Ä—É—Å—Å–∫–∏–π)
PR_BODY="## üß™ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è BugBot

–≠—Ç–æ—Ç PR —Å–æ–∑–¥–∞–Ω –¥–ª—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π BugBot –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É –∫–æ–¥–∞.

### üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ BugBot –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–æ–±–ª–µ–º –≤ –∫–æ–¥–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è

#### üîí –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (3)
- [ ] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∂—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö API –∫–ª—é—á–µ–π
- [ ] –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- [ ] –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π SQL –∏–Ω—ä–µ–∫—Ü–∏–∏

#### üéØ –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ (3)  
- [ ] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ console.log –≤ production –∫–æ–¥–µ
- [ ] –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

#### üìù –ü—Ä–æ–±–ª–µ–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (1)
- [ ] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ TODO/FIXME/HACK –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

#### üåç –ü—Ä–æ–±–ª–µ–º—ã —è–∑—ã–∫–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ (1)
- [ ] –í—ã—è–≤–ª–µ–Ω–∏–µ —Å–º–µ—à–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö

#### ‚ö° –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (2)
- [ ] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
- [ ] –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

### üìà –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- **–í—Å–µ–≥–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å:** 10 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- **–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:** –Ω–µ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç
- **–ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:** –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- **–õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:** –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

### üîç –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
\`test-bugbot-execution.js\` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–Ω–∞–ª–∏–∑–∞.

### ‚úÖ –ü–ª–∞–Ω –ø—Ä–æ–≤–µ—Ä–∫–∏
1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –î–æ–∂–¥–∞—Ç—å—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ BugBot (2-5 –º–∏–Ω—É—Ç)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –í—Å–µ –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
3. **–û—Ü–µ–Ω–∏—Ç—å:** –ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

### üö® –í–∞–∂–Ω–æ
**–≠—Ç–æ—Ç PR –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç (merged)** - —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π PR —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ BugBot.

---

### ü§ñ –°—Ç–∞—Ç—É—Å BugBot
- **–û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞:** ‚è≥ BugBot –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è PR
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞

**–°–æ–∑–¥–∞–Ω–æ:** $(date '+%Y-%m-%d %H:%M:%S')  
**–í–µ—Ç–∫–∞:** $CURRENT_BRANCH  
**–ö–æ–º–º–∏—Ç–æ–≤:** $(git log --oneline | head -5 | wc -l)+

### üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: \`.cursor/BUGBOT_TEST_SCENARIOS.md\`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ BugBot: \`.github/workflows/bugbot.yml\`
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ—Å—Ç–æ–≤: —Å–º. –∑–∞–∫—Ä—ã—Ç—ã–µ PR —Å –º–µ—Ç–∫–æ–π \`bugbot-test\`"

# –°–æ–∑–¥–∞—Ç—å PR
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ PR..."
if command -v gh >/dev/null 2>&1; then
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub CLI..."
    
    PR_URL=$(gh pr create \
        --title "$PR_TITLE" \
        --body "$PR_BODY" \
        --label "test,bugbot-validation,urgent" \
        --draft=false \
        --assignee @me 2>&1 | grep -o 'https://[^[:space:]]*')
    
    if [[ -n "$PR_URL" ]]; then
        echo "‚úÖ PR —Å–æ–∑–¥–∞–Ω: $PR_URL"
        
        # –û—Ç–∫—Ä—ã—Ç—å PR –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
        if command -v xdg-open >/dev/null 2>&1; then
            xdg-open "$PR_URL" 2>/dev/null &
        fi
        
        echo ""
        echo "üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ BugBot:"
        echo "1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ: $PR_URL"
        echo "2. –û–∂–∏–¥–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ BugBot (2-5 –º–∏–Ω—É—Ç)"
        echo "3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã"
        echo ""
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ø–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç)
        echo "‚è±Ô∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ BugBot (10 –º–∏–Ω—É—Ç)..."
        for i in {1..10}; do
            sleep 60  # –ñ–¥—ë–º –º–∏–Ω—É—Ç—É
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            COMMENTS=$(gh pr view --json comments --jq '.comments | length' 2>/dev/null || echo "0")
            
            if [[ $COMMENTS -gt 0 ]]; then
                echo "üéâ BugBot –æ—Ç–≤–µ—á–∞–µ—Ç! –ù–∞–π–¥–µ–Ω–æ $COMMENTS –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"
                echo "üìñ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:"
                gh pr view --comments
                break
            else
                echo "‚è≥ –ú–∏–Ω—É—Ç–∞ $i: BugBot –≤—Å—ë –µ—â—ë –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç..."
            fi
        done
        
        if [[ $COMMENTS -eq 0 ]]; then
            echo "‚ö†Ô∏è  BugBot –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç"
            echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
            echo "   ‚Ä¢ BugBot –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            echo "   ‚Ä¢ Workflow —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞"
            echo "   ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å GitHub Actions"
            echo ""
            echo "üîß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:"
            echo "   gh run list --limit 5"
            echo "   –ò–ª–∏ –ø–µ—Ä–µ–π—Ç–∏: $PR_URL/checks"
        fi
        
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PR"
        exit 1
    fi
else
    echo "‚ùå GitHub CLI –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–°–æ–∑–¥–∞–π—Ç–µ PR –≤—Ä—É—á–Ω—É—é:"
    echo "–ó–∞–≥–æ–ª–æ–≤–æ–∫: $PR_TITLE"
    echo "–û–ø–∏—Å–∞–Ω–∏–µ: —Å–º. –≤—ã—à–µ"
    echo "URL: https://github.com/egorKara/bhagavad-gita-reprint/pull/new/$CURRENT_BRANCH"
fi

echo ""
echo "üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å PR –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ BugBot"
echo "2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º" 
echo "3. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã"
echo "4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å BugBot –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
