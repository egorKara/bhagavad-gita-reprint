#!/bin/bash

echo "üåê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
check_connection() {
    if ping -c 1 -W 5 8.8.8.8 &> /dev/null; then
        echo "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç"
        return 0
    else
        echo "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
restart_network_services() {
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ç–µ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ NetworkManager
    sudo systemctl restart NetworkManager
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ systemd-resolved (DNS)
    sudo systemctl restart systemd-resolved
    
    # –û—á–∏—Å—Ç–∫–∞ DNS –∫—ç—à–∞
    sudo systemd-resolve --flush-caches
    
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥..."
    sleep 10
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
reset_network_settings() {
    echo "üîÑ –°–±—Ä–æ—Å —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
    
    # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1)
    if [ ! -z "$INTERFACE" ]; then
        echo "üì° –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: $INTERFACE"
        sudo ip link set $INTERFACE down
        sleep 2
        sudo ip link set $INTERFACE up
    fi
    
    # –°–±—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–æ–≤
    sudo ip route flush cache
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è DNS
fix_dns() {
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DNS..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö DNS —Å–µ—Ä–≤–µ—Ä–æ–≤
    echo "üìã –¢–µ–∫—É—â–∏–µ DNS —Å–µ—Ä–≤–µ—Ä—ã:"
    cat /etc/resolv.conf
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω—ã—Ö DNS —Å–µ—Ä–≤–µ—Ä–æ–≤
    echo "üì° –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω—ã—Ö DNS —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf.backup
    echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf.backup
    echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf.backup
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if ! check_connection; then
        echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ DNS –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
        sudo cp /etc/resolv.conf.backup /etc/resolv.conf
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ VPN
check_vpn() {
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    if pgrep -x "openvpn" > /dev/null; then
        echo "üîí OpenVPN –∞–∫—Ç–∏–≤–µ–Ω"
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ OpenVPN –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
        if ! check_connection; then
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ OpenVPN..."
            sudo systemctl restart openvpn
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö VPN —Å–µ—Ä–≤–∏—Å–æ–≤
    if pgrep -x "wireguard" > /dev/null; then
        echo "üîí WireGuard –∞–∫—Ç–∏–≤–µ–Ω"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
optimize_network() {
    echo "‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤..."
    
    # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ TCP
    echo "üìä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TCP –±—É—Ñ–µ—Ä–æ–≤..."
    echo 'net.core.rmem_max = 16777216' | sudo tee -a /etc/sysctl.conf
    echo 'net.core.wmem_max = 16777216' | sudo tee -a /etc/sysctl.conf
    echo 'net.ipv4.tcp_rmem = 4096 87380 16777216' | sudo tee -a /etc/sysctl.conf
    echo 'net.ipv4.tcp_wmem = 4096 65536 16777216' | sudo tee -a /etc/sysctl.conf
    
    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    sudo sysctl -p
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    if check_connection; then
        echo "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É..."
    fi
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    restart_network_services
    reset_network_settings
    fix_dns
    check_vpn
    optimize_network
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
    if check_connection; then
        echo "üéâ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!"
    else
        echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É."
    fi
    
    echo ""
    echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º:"
    echo "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ DNS —Å–µ—Ä–≤–µ—Ä—ã (8.8.8.8, 1.1.1.1)"
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"
    echo "   ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
    echo "   ‚Ä¢ –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º"
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@"
